<?php

/**
 * @file
 * Custom module for small, utility-type routines.
 */

use Drupal\migrate\Plugin\MigrationInterface;
use Drupal\migrate\Plugin\MigrateSourceInterface;
use Drupal\migrate\Row;

/**
 * Implements hook_migration_plugins_alter().
 *
 * This routine is cached with the migration. Drush cr for debugging.
 */
function uwm_res_import_migration_plugins_alter(&$migrations) {

  foreach ($migrations as $id => $migration) {

    if ($migration['id'] == 'uwm_res_import_clinics') {

      $config = \Drupal::service('config.factory')
        ->getEditable('migrate_plus.migration.' . $migration['id']);

      $config->set('source.urls', _uwm_clinic_import_urls());
      $config->save();

    }

    elseif ($migration['id'] == 'uwm_res_import_providers') {

      $config = \Drupal::service('config.factory')
        ->getEditable('migrate_plus.migration.' . $migration['id']);

      $config->set('source.urls', _uwm_provider_import_urls());
      $config->save();

    }

  }

}

/**
 * Implements hook_migrate_prepare_row().
 */
function uwm_res_import_migrate_prepare_row(Row $row, MigrateSourceInterface $source, MigrationInterface $migration) {

  $i = 0;

}

/**
 * Provides array of URLs for migration source.
 *
 * @return array
 *   Description here.
 */
function _uwm_clinic_import_urls() {

  $urls = [];
  $url = 'https://bios-reservoir.mktgweb.uwmedicine.org/jsonapi/node/res_clinic?page%5Blimit%5D=10&page%5Boffset%5D={{page}}&sort=nid';
  for ($i = 0; $i < 30; $i++) {
    $urls[] = str_replace('{{page}}', $i, $url);
  }
  return $urls;

}

/**
 * Provides array of URLs for migration source.
 *
 * @return array
 *   Description here.
 */
function _uwm_provider_import_urls() {

  $urls = [];
  $url = 'https://bios-reservoir.mktgweb.uwmedicine.org/jsonapi/node/res_provider?page%5Blimit%5D=10&page%5Boffset%5D={{page}}&sort=nid';
  for ($i = 0; $i < 250; $i++) {
    $urls[] = str_replace('{{page}}', $i, $url);
  }
  return $urls;

}
