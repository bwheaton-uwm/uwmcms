<?php

/**
 * @file
 * Module for reading an API and providing API data to themes.
 */

use Drupal\uwmcs_reader\Controller\UwmFetcher;

/**
 * Implements hook_entity_load().
 */
function uwmcs_reader_entity_load(array $entities, $entity_type_id) {

  foreach ($entities as $entity) {

    if ($entity_type_id === 'node') {

      $args = explode('/', trim(
        \Drupal::request()->getRequestUri(), '/'));
      $nodeType = $entity->getType();
      $fetcher = new UwmFetcher();

      if ($nodeType === 'uwm_clinic') {

        // Fetch Information Manager (IM) data from API endpoint.
        $itemUrl = $entity->field_information_manager_url->value ?? '';
        $possibleSearch = ['clinicUrl' => '/locations/' . $args[1]];
        $resultData = $fetcher->getClinic($itemUrl, $possibleSearch);

        $entity->uwmcs_reader_api_values = $resultData;

      }

      if ($nodeType === 'uwm_provider') {

        // Fetch Information Manager (IM) data from API.
        $fetcher = new UwmFetcher();
        $itemUrl = $entity->field_information_manager_url->value ?? '';
        $possibleSearch = ['friendlyUrl' => $args[1]];
        $resultData = $fetcher->getProvider($itemUrl, $possibleSearch);

        $entity->uwmcs_reader_api_values = $resultData;

      }

      if ($nodeType === 'uwm_medical_service') {

        // Fetch Information Manager (IM) data from API.
        $fetcher = new UwmFetcher();

        $urgent_care_data = $fetcher->getUrl('http://webservices.uwmedicine.org/api/medicalservice/60');
        if (!empty($urgent_care_data->clinics)) {
          $entity->uwmcms_reader_urgent_care_clinics = $urgent_care_data->clinics;
        }

        $primary_care_data = $fetcher->getUrl('http://webservices.uwmedicine.org/api/medicalservice/57');
        if (!empty($primary_care_data->clinics)) {
          $entity->uwmcms_reader_primary_care_clinics = $primary_care_data->clinics;
        }

      }

    }

  }

}
