<?php

/**
 * @file
 * General functionality and hook implementations.
 */

use Drupal\pathauto\PathautoPatternInterface;

/**
 * Implements hook_preprocess_HOOK().
 */
function uwmcms_chew_misc_preprocess_block__views_block__related_articles_block(&$variables) {
  if (isset($variables['content']['#view'])) {
    $view = $variables['content']['#view'];
    if (empty($view->result)) {
      unset($variables['content']);
    }
  }
}

/**
 * Implements hook_pathauto_pattern_alter().
 */
function uwmcms_chew_misc_pathauto_pattern_alter(PathautoPatternInterface &$pattern, array $context) {
  if ($pattern->id() == 'article') {
    if (isset($context['data']['node'])) {
      $node = $context['data']['node'];
      $category = $node->field_categories->entity;
      if (isset($category)) {
        $parents = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadParents($category->id());
        if (!empty($parents)) {
          $parent = array_shift($parents);
          $parent_part = Drupal::service('pathauto.alias_cleaner')->cleanString($parent->getName());
          $altered_pattern =$parent_part . '/' . $pattern->getPattern();
          $pattern->setPattern($altered_pattern);
        }
      }
    }
  }
}

/**
 * Implements hook_preprocess_HOOK() for main menu.
 */
function uwmcms_chew_misc_preprocess_menu__main(&$variables) {
  // Remove the "All" menu items.
  foreach ($variables['items'] as $parent_id => $parent_item) {
    foreach ($parent_item['below'] as $id => $item) {
      if (isset($item['title']) && $item['title'] == 'All') {
        unset($variables['items'][$parent_id]['below'][$id]);
      }
    }
  }
}
