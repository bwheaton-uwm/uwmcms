{% extends "@uwmbase/containers/article/article.twig" %}

{#
/**
 * @file
 * Theme override to display a Res Provider in full-page view mode.
 *
 * @see template_preprocess_node()
 * @see uwmbase_preprocess_node()
 *
 */
#}

{% set modifier_class = attributes.class ~ ' container-xl' %}
{% set modifier_class = has_ratings ? modifier_class ~ ' node-res_provider--has-ratings' : modifier_class ~ ' node-res_provider--no-ratings' %}
{%
  set taxonomy_subsection_attributes = create_attribute({
    'class': [
      'provider-page__section1-area2-subsection',
      'col-12'
    ]
  })
%}
{%
  set specialties_subsection_attributes = create_attribute({
    'class': [
      'provider-page__section1-area2-subsection',
      taxonomy_terms.conditions_symptoms is not empty or taxonomy_terms.procedures_treatments is not empty ? 'provider-page__section1-area2-subsection--inline',
      'col-12'
    ]
  })
%}

{% block content %}
    {{ attach_library('uwmbase/provider-page') }}
    {{ title_suffix }}

    {# TODO: remove temporary testing info.
       @see uwmcs_ecare_scheduling_preprocess_node() #}
    {{ testing_data }}

    <div class="bg provider-page">
        <section class="provider-page__section1">
            <div class="provider-page__section1-area1">
                <h1 class="provider-page__section1-name page-title d-block d-lg-none">{{ label }}</h1>
                <div class="provider-page__section1-photo">
                    {% if has_photo %}
                        {{ content.field_res_image }}
                    {% else %}
                        <img src="/{{ directory }}/dist/assets/provider-silhouette.svg" alt="" />
                    {% endif %}
                </div>
                <div class="provider-page__section1-area1-subsection">
                    <div class="provider-page__section1-accepting-patients">
                        {#
                            These booleans are pulled from fields:
                            `field_res_isacceptingnewpts`
                            `field_res_isacceptingreturnpts`
                            @see uwmcs_ecare_scheduling_preprocess_node()
                        #}
                        {% if accepting_new and accepting_returning %}
                            <i class="uwm-icon uwm-icon--accepting-patients-teal" aria-hidden="true"></i>
                            {{ "Accepting new and returning patients"|t }}
                        {% elseif accepting_returning and (not accepting_new)  %}
                            <i class="uwm-icon uwm-icon--accepting-patients-purple" aria-hidden="true"></i>
                            {{ "Accepting returning patients"|t }}
                        {% elseif accepting_new and (not accepting_returning) %}
                            {#
                                NOTE: this case is probably unrealistic and
                                indicates bad data. Handle it by providing
                                what options we know we have.
                            #}
                            <i class="uwm-icon uwm-icon--accepting-patients-teal" aria-hidden="true"></i>
                            {{ "Accepting new patients"|t }}
                        {% else %}
                            {#
                                No message if provider does not accept any type
                                of appointments.
                            #}
                        {% endif %}
                    </div>
                    {% if accepting_returning or accepting_new %}
                        <div class="provider-page__section1-appt-actions">
                            {% include directory ~ '/components/provider-page/node--res-provider--appointment-actions.html.twig' with {
                                'modal_appt_context': 'provider_page',
                                'class_prefix': 'provider-page__section1'
                            } %}
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="provider-page__section1-area2">
                <h1 class="provider-page__section1-name page-title d-none d-lg-block">{{ label }}</h1>
                <div class="provider-page__section1-taxonomy">
                  {% if taxonomy_terms.expertises is not empty %}
                      <div{{ specialties_subsection_attributes }}>
                          <h2 class="provider-page__section1-subheading">{{ (taxonomy_terms.expertises|length > 1) ? "Medical Specialties"|t : "Medical Specialty"|t }}</h2>
                          <ul class="provider-page__section1-list">
                              {% for term in taxonomy_terms.expertises %}
                                  <li class="provider-page__section1-list-item">
                                      {% if term.url is not empty %}
                                          {{ uwm_cta_link(term.name, term.url, ['text-link-blue', 'no-underline']) }}
                                      {% else %}
                                          {{ term.name }}
                                      {% endif %}
                                  </li>
                              {% endfor %}
                          </ul>
                      </div>
                  {% endif %}
                  {% set taxonomy_subsection_classes = [
                      taxonomy_terms.conditions_symptoms is not empty and taxonomy_terms.procedures_treatments is not empty ? 'col-md-6' : '',
                  ] %}
                  {% if taxonomy_terms.conditions_symptoms is not empty %}
                      <div{{ taxonomy_subsection_attributes.addClass(taxonomy_subsection_classes) }}>
                          <h2 class="provider-page__section1-subheading">{{ "Top Conditions &amp; Symptoms"|t }}</h2>
                          <ul class="provider-page__section1-list">
                              {% for term in taxonomy_terms.conditions_symptoms %}
                                  <li class="provider-page__section1-list-item">
                                      {% if term.url is not empty %}
                                          {{ uwm_cta_link(term.name, term.url, ['text-link-blue', 'no-underline']) }}
                                      {% else %}
                                          {{ term.name }}
                                      {% endif %}
                                  </li>
                              {% endfor %}
                          </ul>
                      </div>
                  {% endif %}
                  {% if taxonomy_terms.procedures_treatments is not empty %}
                      <div{{ taxonomy_subsection_attributes.addClass(taxonomy_subsection_classes) }}>
                          <h2 class="provider-page__section1-subheading">{{ "Top Procedures &amp; Treatments"|t }}</h2>
                          <ul class="provider-page__section1-list">
                              {% for term in taxonomy_terms.procedures_treatments %}
                                  <li class="provider-page__section1-list-item">
                                      {% if term.url is not empty %}
                                          {{ uwm_cta_link(term.name, term.url, ['text-link-blue', 'no-underline']) }}
                                      {% else %}
                                          {{ term.name }}
                                      {% endif %}
                                  </li>
                              {% endfor %}
                          </ul>
                      </div>
                  {% endif %}
                </div>
            </div>
        </section>
        <section class="provider-page__section2">
            {% include directory ~ '/components/provider-page/node--res-provider--tabs.html.twig' %}
        </section>

        {#
            TEST: embed open scheduling iframe using POC environment.
            Use default markup example provided.
        #}
        {% if epic_id is not empty and open_scheduling and visit_type_ids is not empty %}

            {% set ecare_poc_host = 'https://pocecare18.epic.medical.washington.edu/poc' %}
            {% set ecare_poc_domain = 'https://pocecare18.epic.medical.washington.edu' %}

            <section>
                <h2>Test open scheduling widget - eCare POC environment:</h2>

                <div id="scheduleContainer">
                    <iframe id="openSchedulingFrame" scrolling="no" src="{{ ecare_poc_host }}/OpenScheduling/SignupAndSchedule/EmbeddedSchedule?id={{ epic_id }}&vt={{ visit_type_ids.0 }}&view=plain"></iframe>
                </div>

                <link href="{{ ecare_poc_host }}/Content/EmbeddedWidget.css" rel="stylesheet" type="text/css">

                <script src="{{ ecare_poc_host }}/Content/EmbeddedWidgetController.js" type="text/javascript"></script>

                <script type="text/javascript">
                    var EWC = new EmbeddedWidgetController({
                        // Replace with the hostname of your Open Scheduling site
                        'hostname':'{{ ecare_poc_domain }}',

                        // Must equal media query in EpicWP.css + any left/right margin of the host page. Should also change in EmbeddedWidget.css
                        'matchMediaString':'(max-width: 747px)',

                        //Show a button on top of the widget that lets the user see the slots in fullscreen.
                        'showToggleBtn':true,

                        //The toggle buttonâ€™s help text for screen reader.
                        'toggleBtnExpandHelpText': 'Expand to see the slots in fullscreen',
                        'toggleBtnCollapseHelpText': 'Exit fullscreen',
                    });
                </script>
            </section>

        {% endif %}
    </div>
{% endblock %}
